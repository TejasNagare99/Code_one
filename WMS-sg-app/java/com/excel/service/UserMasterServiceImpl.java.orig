package com.excel.service;

import java.util.Calendar;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.ServletContext;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import com.excel.bean.ChangePasswordBean;
import com.excel.exception.MedicoException;
import com.excel.model.Company;
import com.excel.model.FinYear;
import com.excel.model.LoginDetails;
import com.excel.model.Period;
import com.excel.model.Usermaster;
import com.excel.repository.FinancialYearRepository;
import com.excel.repository.PeriodMasterRepository;
import com.excel.repository.TransactionalRepository;
import com.excel.repository.UserMasterRepository;
import com.excel.security.PasswordManager;
import com.excel.utility.MedicoConstants;

@Service
public class UserMasterServiceImpl implements UserMasterService, MedicoConstants {

	@Autowired private UserMasterRepository userMasterRepository;
	@Autowired private FinancialYearRepository financialYearRepository;
	
//	@Autowired private ParameterRepository parameterRepository;
//	@Autowired private FieldDetailRepository fieldDetailRepository;
	@Autowired private PeriodMasterRepository periodMasterRepository;
//	@Autowired private LeaveFinancialYearRepository leaveFinancialYearRepository;
//	@Autowired private FieldMasterRepository fieldMasterRepository;
	@Autowired private TransactionalRepository transactionalRepository;
//	@Autowired private DivFieldRepository divFieldRepository;
//	@Autowired private LeaveMasterService leaveMasterService;
//	@Autowired private FareTableRepository fareTableRepository;
//	@Autowired private RouteMasterRepository routeMasterRepository;
//	@Autowired private ExpenseMasterRepository expenseMasterRepository;
//	@Autowired private FieldMasterService fieldMasterService;
//	@Autowired private WeekMasterRepository weekMasterRepository;
//	@Autowired private CustomerMappingRepository customerMappingRepository;
//	@Autowired private CustomerTypeRepository customerTypeRepository;
//	@Autowired private FeedbackTypeRepository feedbackTypeRepository;

	@Override
	public Map<String, Object> login(String username, String password, Boolean checkLock, String company_code) throws Exception {
		Map<String, Object> map = new HashMap<>();
		map.put("ALLOW", false);
		Usermaster user = this.userMasterRepository.getUserByUsername(username);
		boolean isTempPassword = false;
		boolean deleteTransactionTables = false;
		boolean isPresent = false;
		if (user == null) {
			throw new MedicoException("User Not Found.");
		}
		if (!password.equals(PasswordManager.decrypt(PasswordManager.decrypt(user.getLd_pass())))) {
			throw new MedicoException("Incorrect Password.");
		}
		if (!user.getLd_status().equalsIgnoreCase(A)) {
			throw new MedicoException("The user is deactivated.");
		}
		if (!(user.getUser_lock().equalsIgnoreCase(N) || !checkLock)) {
			throw new MedicoException("The user is logged in from another machine.");
		}
//		if (MedicoResources.atStartOfDay(new Date()).compareTo(MedicoResources.atStartOfDay(user.getExpiry_date())) > 0) {
//			throw new MedicoException("Your password has expired. Please contact your account administrator or click on Forgot Password.");
//		}
		if (user.getIs_temp().trim().equalsIgnoreCase(Y)) {
			isTempPassword = true;
		}
		
		if (!isTempPassword) {
			Map<Long, String> finYears = new LinkedHashMap<Long, String>();
			String from = "";
			String to = "";
			String sbuName = null;
			String division = null;
			String heading1 = null;
			String heading2 = null;
			String heading3 = null;
			String heading1Value = null;
			String heading2Value = null;
			String heading3Value = null;
//			if(user.getUser_division() != null && Long.parseLong(user.getUser_division().trim()) != 0L) {
//				sbuName = this.parameterRepository.getParameterByParaId(Long.parseLong(user.getUser_division().trim()), user.getCompany_cd()).getSbu();
//			}
//			List<Parameters> paraList = this.parameterRepository.getParametersByParaTypes(Arrays.asList(DIV, FLD), user.getCompany_cd());
//			List<FinancialYear> financialYears = financialYearRepository.getAllFinancialYears(user.getCompany_cd());
//			List<FinancialYear> finList = financialYears.stream().filter(f -> f.getFin_year_closed().equalsIgnoreCase(N)).collect(Collectors.toList());
//			List<PeriodMaster> periodList = this.periodMasterRepository.getPeriodMasterByFinYear(finList.get(0).getFin_year_id(), user.getCompany_cd());
//			periodList.stream().forEach(p -> {
//				p.setStart_date_time(p.getStart_date().getTime());
//				p.setEnd_date_time(p.getEnd_date().getTime());
//			});
//			List<DivField> divisionWiseFields = this.divFieldRepository.getAllDataByCompany(companyCode);
//			LeaveFinancialYear leaveFinancialYear = this.leaveFinancialYearRepository.getOpenLeaveFinancialYear();
//			List<Parameters> currencies = this.parameterRepository.getParametersByParaType(CUR, companyCode);
//			if (currencies != null) {
//				map.put("currency", currencies.get(0));
//			}
//			financialYears.stream().forEach(f -> {
//				f.setStart_date_time(f.getStart_dt().getTime());
//				f.setEnd_date_time(f.getEnd_dt().getTime());
//			});
//			
//			if (!MedicoResources.CHECK_HO_USER_BY_LEVEL_CODE(user.getLevel_code())) {
//				division = this.parameterRepository.getParaDescrByParaId(Long.parseLong(user.getUser_division().trim()), companyCode);
//			}
//			for (FinancialYear f : financialYears) {
//				from = f.getStart_dt().toString().substring(8,10) + "-" + f.getStart_dt().toString().substring(5,7) + 
//						"-" + f.getStart_dt().toString().substring(0,4);
//				to   = f.getEnd_dt().toString().substring(8,10) + "-" + f.getEnd_dt().toString().substring(5,7) + 
//						"-" + f.getEnd_dt().toString().substring(0,4);
//				finYears.put(f.getFin_year_id(), from + " To " + to);
//			}
//			
//			List<Parameters> fieldParameterList = paraList.stream().filter(p -> p.getPara_type().equalsIgnoreCase(FLD)).collect(Collectors.toList());
//			if (levelCode.equalsIgnoreCase(LEVEL_CODE_005)) {
//				List<FieldDetailView> fieldList = this.fieldDetailRepository.getFieldDetailsByMsrId(fieldStaffId, companyCode);
//				heading1 = "HQ";
//				heading2 = fieldParameterList.stream().
//						filter(p -> p.getPara_code().equalsIgnoreCase(PARA_CODE_004)).findFirst().get().getPara_descr();
//				heading3 = fieldParameterList.stream().
//						filter(p -> p.getPara_code().equalsIgnoreCase(PARA_CODE_003)).findFirst().get().getPara_descr();
//				heading1Value = fieldList.get(0).getHq_name();
//				heading2Value = fieldList.get(0).getAm_name();
//				heading3Value = fieldList.get(0).getRm_name();
//			} else if (levelCode.equalsIgnoreCase(LEVEL_CODE_004)) {
//				List<FieldDetailView> fieldList = this.fieldDetailRepository.getFieldDetailsByAmId(fieldStaffId, companyCode);
//				heading1 = "AREA";
//				heading2 = fieldParameterList.stream().
//						filter(p -> p.getPara_code().equalsIgnoreCase(PARA_CODE_003)).findFirst().get().getPara_descr();
//				heading3 = fieldParameterList.stream().
//						filter(p -> p.getPara_code().equalsIgnoreCase(PARA_CODE_002)).findFirst().get().getPara_descr();
//				heading1Value = fieldList.get(0).getArea_name();
//				heading2Value = fieldList.get(0).getRm_name();
//				heading3Value = fieldList.get(0).getDm_name();
//			} else if (levelCode.equalsIgnoreCase(PARA_CODE_003)) {
//				List<FieldDetailView> fieldList = this.fieldDetailRepository.getFieldDetailsByRmId(fieldStaffId, companyCode);
//				heading1 = "REGION";
//				heading2 = fieldParameterList.stream().
//						filter(p -> p.getPara_code().equalsIgnoreCase(PARA_CODE_002)).findFirst().get().getPara_descr();
//				heading3 = fieldParameterList.stream().
//						filter(p -> p.getPara_code().equalsIgnoreCase(PARA_CODE_001)).findFirst().get().getPara_descr();
//				heading1Value = " - ";
//				heading2Value = fieldList.get(0).getDm_name();
//				heading3Value = fieldList.get(0).getZm_name();
//			}
//			String designation = null;
//			if (MedicoResources.CHECK_HO_USER_BY_LEVEL_CODE(user.getLevel_code())) {
//				designation = "HO";
//			} else {
//				designation = this.parameterRepository.getParaDescrByParaTypeAndCode(FLD, user.getLevel_code(), companyCode);
//			}
//			List<Parameters> divisionList = null;
//			if (!MedicoResources.CHECK_HO_USER_BY_LEVEL_CODE(user.getLevel_code())) {
//				List<Long> userDivisions = MedicoResources.splitUserDivisions(user.getUser_division());
//				divisionList = this.parameterRepository.getParametersByParaTypeAndParaIds(DIV, companyCode, userDivisions);
//			} else {
//				divisionList = paraList.stream().filter(p -> p.getPara_type().equalsIgnoreCase(DIV)).collect(Collectors.toList());
//			}
//			Company companyMaster = this.companyMasterRepository.getCompanyDetails();
//			user.setExpiry_date_time(user.getExpiry_date().getTime());
//			user.setDecrypted_password(password);
//			System.out.println("fcmToken::"+fcmToken);
//			if (fcmToken != null) {
//				user.setFcm_token(fcmToken);
//				this.transactionalRepository.update(user);
//			}
			//this.userMasterRepository.lockOrUnlockUser(user.getUser_id(), true);
//			map.put("user", user);
//			map.put("currentFinYearData", finList.get(0));
//			map.put("allPeriods", periodList);
//			map.put("currentPeriod", periodList.stream().filter(p -> p.getPeriod_closed().equalsIgnoreCase(N)).findFirst().get());
//			map.put("divisions", divisionList);
//			map.put("finYearMap", finYears);
//			map.put("financialYears", financialYears);
//			map.put("leaveFinancialYear", leaveFinancialYear);
//			map.put("heading1", heading1);
//			map.put("heading2", heading2);
//			map.put("heading3", heading3);
//			map.put("heading1Value", heading1Value);
//			map.put("heading2Value", heading2Value);
//			map.put("heading3Value", heading3Value);
//			map.put("divisionName", division);
//			if (!MedicoResources.CHECK_HO_USER_BY_LEVEL_CODE(user.getLevel_code())) {
//				map.put("divisionId", Long.parseLong(user.getUser_division().trim()));
//			}
//			map.put("companyCode", user.getCompany_cd());
//			map.put("finYearId", finList.get(0).getFin_year_id());
//			map.put("designation", designation);
//			map.put("financialYears", financialYears);
//			map.put("companyMaster", companyMaster);
//			map.put("divisionWiseFields", divisionWiseFields);		
			
			
			LoginDetails login_details= userMasterRepository.getLoginDetailsByUserName(username);
			HashMap<String, String> data = userMasterRepository.getUserInfo(username, password);
			Period periodData = periodMasterRepository.getPeriodMasterByCompany(company_code);
			FinYear fin_year = financialYearRepository.getCurrentFinancialYear(company_code); // to get the FinYear Object.
			
			if(fin_year==null){throw new MedicoException("Financial Year not found.");}
			map.put("loggedInUser", username);
			map.put("FNAME", data.get("FNAME"));
			map.put("MNAME", data.get("MNAME"));
			map.put("LNAME", data.get("LNAME"));
			map.put("EMP_ID", data.get("EMP_ID"));
			map.put("USER_ROLE",data.get("USER_ROLE"));
			map.put("DEPTLOC", data.get("DEPTLOC"));
			map.put("USER_GROUP_ID",data.get("GROUP_ID"));
			map.put("USER_TYPE",data.get("USER_TYPE"));
			map.put("USER_DIVISION", userMasterRepository.getUserDivision(data.get("EMP_ID")));
			map.put("CURR_PERIOD", periodData.getPeriod_code());
			map.put("CURR_FIN_YEAR", periodData.getPeriod_fin_year());
			map.put("LOGIN_DETAILS_SG", login_details);
			map.put("EMP_EMAIL", login_details.getEmp_email());
			//map.put("USER_LOCATION",master.getUserLocation(data.get("EMP_ID")));
			//map.put("USER_DIV_ARRAY",master.getFormatedUserDivision(data.get("EMP_ID")));
			//map.put("LOGIN_EXPIRY_DAY",new SystemParameterDao().getSpValueBySpName("Login_Expired_Day").getSp_value());
			map.put("Fin_yr_stdt", fin_year.getFin_start_date());
			//this is current period object
			map.put("period_obj", periodData);
			//newly added for GST
			map.put("gst_ind", (fin_year.getGst_ind()!=null && fin_year.getGst_ind()!="") ? fin_year.getGst_ind() : "N");
			map.put("gst_curr_year", fin_year.getGst_curr_year());
			map.put("gst_start_date", fin_year.getGst_start_date());
			map.put("vat_transition_end", fin_year.getVat_transition_end());
			map.put("EMP_LOC", data.get("EMP_LOC"));
			map.put("stock_at_cfa_ind", "Y"); //from company master
			
			user.setPassword_lock("N");
			user.setUser_lock("Y");
			//transactionalRepository.update(user);
			/******* to get Broadcast message data ****************/
//			brdcastingMessage = (new CastMessage().allMessagesToShow(data.get("GROUP_ID"), data.get("EMP_ID"),
//					master.getFormatedUserDivision(data.get("EMP_ID"))));
//			Long timeStamp = new Date().getTime();
//			map.put("timeStamp", timeStamp);
//			map.put("message", brdcastingMessage);
//			loginStatus="Successful Login";
//			attemptsLog.setLogin_status(loginStatus);
//			master.saveAttemptLog(hsession,attemptsLog);
//			tx.commit();			
//			if(user.getUser_division() != null && Long.parseLong(user.getUser_division().trim()) != 0L) {
//				map.put("sbuName", sbuName);
//				map.put("sbu", sbuName);
//			}
			map.put("ALLOW", true);
			map.put("IS_TEMP_PWD", false);
		} else {
			map.put("ALLOW", true);
			map.put("IS_TEMP_PWD", true);
		}
		return map;
	}

	@Override
	public void lockOrUnlockUser(Long userId, boolean lock) throws Exception {
		userMasterRepository.lockOrUnlockUser(userId, lock);
	}

	@Override
	public void unlockAllUsers() throws Exception {
		userMasterRepository.unlockAllUsers();
	}

	

	@Override
	public List<Usermaster> getLockedUsers(String levelCode) throws Exception {
		return userMasterRepository.getLockedUsers(levelCode);
	}

	@Override
	public void unlockorLockUsersByUsernames(List<String> usernames, String lockUnlock) throws Exception {
		userMasterRepository.unlockorLockUsersByUsernames(usernames, lockUnlock);
	}


	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void changePassword(ChangePasswordBean bean) throws Exception {
		Usermaster user = this.userMasterRepository.getUserByUsername(bean.getUsername());
		if (user == null) {
			throw new MedicoException("User not found.");
		}
		if (!bean.getOldPassword().equals(PasswordManager.decrypt(PasswordManager.decrypt(user.getLd_pass())))) {
			throw new MedicoException("Incorrect old password.");
		}
		if (!bean.getNewPassword().equals(bean.getConfirmNewPassword())) {
			throw new MedicoException("Passwords do not match.");
		}
		this.userMasterRepository.updatePasswordByUsername(bean.getUsername(), bean.getNewPassword());
	}

	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void sendPassword(Usermaster user, String password) throws Exception {
		String encryptedPassword = PasswordManager.encrypt(PasswordManager.encrypt(password));
		Calendar calendar = Calendar.getInstance();
		//calendar.add(Calendar.DATE, user.getExpiry_days().intValue());
		//Date expiryDate = calendar.getTime();
		//user.setExpiry_date(MedicoResources.atStartOfDay(expiryDate));
		user.setLd_pass(encryptedPassword);
		user.setIs_temp("Y");
		this.transactionalRepository.update(user);
	}

	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public String changeTemporaryPassword(String username, String password) throws Exception {
//		Usermaster user = this.userMasterRepository.getUserByUsername(username);
//		if (user == null) {
//			throw new MedicoException("That username does not matches any of our records.");
//		}
//		String encryptedPassword = PasswordManager.encrypt(PasswordManager.encrypt(password));
//		Calendar calendar = Calendar.getInstance();
//		if (user.getExpiry_days() != null && user.getExpiry_days().compareTo(0L) != 0) {
//			calendar.add(Calendar.DATE, user.getExpiry_days().intValue());
//		} else {
//			calendar.add(Calendar.DATE, 90);
//		}
//		Date expiryDate = calendar.getTime();
//		user.setExpiry_date(MedicoResources.atStartOfDay(expiryDate));
//		user.setEnc_password(encryptedPassword);
//		user.setHash_password(new BCryptPasswordEncoder().encode(password));
//		user.setIs_temp_pwd(N);
//		this.transactionalRepository.update(user);
//		return "Password change successfull. Your password will expire on "
//				+ MedicoResources.convertUtilDateToString_DD_MM_YYYY(expiryDate) + ". " + "Please login to continue.";
	return null;
	}

	@Override
	public Object getObjectByUsername(String username) throws Exception {
		return this.userMasterRepository.getUserByUsername(username);
	}

	@Override
	public Usermaster getUserByUsername(String username) throws Exception {
		return this.userMasterRepository.getUserByUsername(username);
	}

	@Override
	public Usermaster getUserByFsId(Long fsId) throws Exception {
		return userMasterRepository.getUserByFsId(fsId);
	}

	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void fixUserPassword(String companyCode) throws Exception {
//		List<Usermaster> users = this.userMasterRepository.getAllUsers(companyCode);
//		if (users != null) {
//			int count = 1;
//			for (Usermaster user : users) {
//				if (user.getUser_password() != null) {
//					System.out.println(count);
//					user.setEnc_password(PasswordManager.encrypt(PasswordManager.encrypt(user.getUser_password())));
//					user.setHash_password(new BCryptPasswordEncoder().encode(user.getUser_password()));
//					Calendar calendar = Calendar.getInstance();
//					if (user.getExpiry_days() != null && user.getExpiry_days().compareTo(0L) != 0) {
//						calendar.add(Calendar.DATE, user.getExpiry_days().intValue());
//					} else {
//						calendar.add(Calendar.DATE, 90);
//					}
//					user.setExpiry_date(MedicoResources.atStartOfDay(calendar.getTime()));
//					this.transactionalRepository.update(user);
//					count++;
//				}
//			}
//		}
	}

	@Override
	public String getAllowBatchCreateInd(String empId) throws Exception {
		return this.userMasterRepository.getAllowBatchCreateInd(empId);
	}

}
