package com.excel.repository;

import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.ParameterMode;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.persistence.StoredProcedureQuery;
import javax.persistence.Tuple;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Root;
import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;

import com.excel.model.GrnDetails;
import com.excel.model.GrnDetails_;
import com.excel.model.GrnHeader;
import com.excel.model.GrnHeader_;
import com.excel.model.PpgNextNumberCust;
import com.excel.model.V_GRN_Header;
import com.excel.model.V_Grn_Details;
import com.excel.model.V_Grn_Details_;
import com.excel.utility.MedicoConstants;

@Repository
public class GrnRepositoryImpl implements GrnRepository{

	@PersistenceContext private EntityManager entityManager;
	@Autowired private EntityManagerFactory emf;
	static String newFilePath = null;
	
	@Override
	public GrnHeader getObjectById(Long grnId) throws Exception {
		return this.entityManager.find(GrnHeader.class, grnId);
	}
	
	@Override
	public GrnDetails getObjectByDetailId(Long grnDetailId) throws Exception {
		return this.entityManager.find(GrnDetails.class, grnDetailId);
	}
	
	@Override
	public Long getMaxGrnId() throws Exception {
		EntityManager em = null;
		Long grnId = null;
		try {
			em = emf.createEntityManager();
			CriteriaBuilder builder = em.getCriteriaBuilder();
			CriteriaQuery<Long> criteriaQuery = builder.createQuery(Long.class);
			Root<GrnHeader> root = criteriaQuery.from(GrnHeader.class);
			criteriaQuery.select(builder.max(root.get(GrnHeader_.grnId)));
			grnId = em.createQuery(criteriaQuery).getSingleResult();
		} finally {
			if (em != null) { em.close(); }
		}
		return grnId;
	}
	
	@Override
	public BigDecimal getTotalGrnValueByGrnId(Long grnId, Long grnDetailId) throws Exception {
		EntityManager em = null;
		BigDecimal value = null;
		try {
			em = emf.createEntityManager();
			CriteriaBuilder builder = em.getCriteriaBuilder();
			CriteriaQuery<BigDecimal> criteriaQuery = builder.createQuery(BigDecimal.class);
			Root<GrnDetails> root = criteriaQuery.from(GrnDetails.class);
			if(grnDetailId == null) {
				criteriaQuery.select(builder.sum(root.get(GrnDetails_.grnd_value)))
				.where(builder.equal(root.get(GrnDetails_.grndGrnId), grnId));
			} else {
				criteriaQuery.select(builder.sum(root.get(GrnDetails_.grnd_value)))
				.where(builder.and(builder.equal(root.get(GrnDetails_.grndGrnId), grnId)),
						builder.and(builder.notEqual(root.get(GrnDetails_.grndId), grnDetailId)));
			}
			
			value = em.createQuery(criteriaQuery).getSingleResult();
		} finally {
			if (em != null) { em.close(); }
		}
		return value;
	}
	
	@Override
	public String getGrnNumber(String avField_Nm, String avTable_Nm, String avCharDigit, String avwherecondn) throws Exception {
		EntityManager em = null;
		String grnNumber = null;
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query = em.createStoredProcedureQuery("PPG_NEXT_NUMBER_CUST");

			query.registerStoredProcedureParameter(1, String.class, ParameterMode.IN);
			query.registerStoredProcedureParameter(2, String.class, ParameterMode.IN);
			query.registerStoredProcedureParameter(3, String.class, ParameterMode.IN);
			query.registerStoredProcedureParameter(4, String.class, ParameterMode.IN);
			query.registerStoredProcedureParameter(5, String.class, ParameterMode.OUT);

			query.setParameter(1, avField_Nm);
			query.setParameter(2, avTable_Nm);
			query.setParameter(3, avCharDigit);
			query.setParameter(4, avwherecondn);
			query.execute();
			grnNumber = (String) query.getOutputParameterValue(5);
		} finally {
			if (em != null) { em.close(); }
		}
		return grnNumber;
	}
	
	public String getGrnNumbernew(String avField_Nm, String avTable_Nm, String avCharDigit, String avwherecondn) throws Exception {
		EntityManager em = null;
		String grnNumber = null;
		PpgNextNumberCust obj = null;
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query = em.createNamedStoredProcedureQuery("callPpgNextNumberCust");
			query.setParameter("avField_Nm", avField_Nm);
			query.setParameter("avTable_Nm", avTable_Nm);
			query.setParameter("avCharDigit", avCharDigit);
			query.setParameter("avwherecondn", avwherecondn);
			obj = (PpgNextNumberCust) query.getSingleResult();
			grnNumber = obj.getGrnId();
		} finally {
			if (em != null) { em.close(); }
		}
		return grnNumber;
	}
	
	@Override
	public List<V_Grn_Details> getGrnDetailViewByGrnId(Long grnId) throws Exception {
		EntityManager em = null;
		List<V_Grn_Details> list = null;
		try {
			System.out.println("grnId"+grnId);
			em = emf.createEntityManager();
			CriteriaBuilder builder = em.getCriteriaBuilder();
			CriteriaQuery<V_Grn_Details> criteriaQuery = builder.createQuery(V_Grn_Details.class);
			Root<V_Grn_Details> root = criteriaQuery.from(V_Grn_Details.class);
			criteriaQuery.select(root).where(
				builder.and(
						builder.equal(root.get(V_Grn_Details_.grndGrnId), grnId)
						)
				).orderBy(builder.asc(root.get(V_Grn_Details_.grndId)));
			list = em.createQuery(criteriaQuery).getResultList();
		} finally {
			if(em != null) { em.close(); }
		}
		if(list != null && !list.isEmpty()) {
			return list;
		}
		return null;
	}	
	
	@Override
	public boolean checkIfBatchExistsInGrnDetail(Long grnId, Long prodId, Long batchId) throws Exception {
		EntityManager em = null;
		List<GrnDetails> list = null;
		try {
			em = emf.createEntityManager();
			CriteriaBuilder builder = em.getCriteriaBuilder();
			CriteriaQuery<GrnDetails> criteriaQuery = builder.createQuery(GrnDetails.class);
			Root<GrnDetails> root = criteriaQuery.from(GrnDetails.class);
			criteriaQuery.select(root)
			.where(builder.equal(root.get(GrnDetails_.grndGrnId), grnId),
					builder.equal(root.get(GrnDetails_.grnd_batch_id), batchId),
					builder.equal(root.get(GrnDetails_.grnd_prod_id), prodId));
			list = em.createQuery(criteriaQuery).getResultList();
			if(list != null && list.size()>0) {
				return true;
			} else {
				return false;
			}
		} finally {
			if (em != null) { em.close(); }
		}
	}
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void deleteById(Long grndetailId) throws Exception {
		this.entityManager.createQuery(" DELETE FROM GrnDetails AS g WHERE g.grndId = :grndetailId ")
		.setParameter("grndetailId", grndetailId)
		.executeUpdate();
	}
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void updateBatchForGrn(Long batch_id,BigDecimal grn_qty) {
	    System.out.println("In Batch Update For GRN "+batch_id+" "+grn_qty);
	    
	    this.entityManager.createQuery(" Update SmpBatch set batch_with_held_qty = batch_with_held_qty - :grn_qty where batch_id = :batch_id ")
		.setParameter("batch_id", batch_id)
		.setParameter("grn_qty", grn_qty)
		.executeUpdate();
	}
	
	@Override
	public List<GrnDetails> getGrnDetailsByGrnId(Long grn_id)
			throws Exception {
		EntityManager em = null;
		List<GrnDetails> list = null;
		try {
			em = emf.createEntityManager();
			CriteriaBuilder builder = em.getCriteriaBuilder();
			CriteriaQuery<GrnDetails> criteriaQuery = builder.createQuery(GrnDetails.class);
			Root<GrnDetails> root = criteriaQuery.from(GrnDetails.class);
			criteriaQuery.select(root)
			.where(builder.equal(root.get(GrnDetails_.grndGrnId), grn_id),
					builder.equal(root.get(GrnDetails_.grnd_status), "A"));
			list = em.createQuery(criteriaQuery).getResultList();
		} finally {
			if (em != null) { em.close(); }
		}
		return list;
	}
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void updateBatchQuarantine(Long batch_id,BigDecimal qty) {
		this.entityManager.createQuery(" UPDATE smpbatch set quanrantine = isnull(quanrantine,0) + :qty where batch_id = :batch_id ")
		.setParameter("batch_id", batch_id)
		.setParameter("qty", qty)
		.executeUpdate();
	}

	
	
	@Override
	public Map<String, Object> getGrnApprovalHeaderDetail(@RequestParam String empId,@RequestParam String empLoc){
		Map<String, Object> map=new HashMap<>();
		System.out.println("emp location is: "+empLoc+".."+empId);
		String loginId=empId;
		List<V_GRN_Header> list=new ArrayList<>();
		
		EntityManager em = null;
		
		try {
			String q = null;Query query = null ;
			em = emf.createEntityManager();
			if(loginId.equals("E00040")) {
				q="select grn_id,grn_dt_disp,grn_no,grn_lr_no,grn_lr_dt_disp,grn_transfer_no,grn_transfer_dt_disp,trantype,grn_company from v_GRN_HEADER where GRN_ins_usr_id=:empId and GRN_APPR_STATUS='E' and GRN_LOC_ID=:empLoc order by GRN_NO";
				query  = em.createNativeQuery(q,Tuple.class);
				query.setParameter("empId", empId);
				query.setParameter("empLoc", empLoc);
			}
			if(loginId.equals("E00118") || empId.equals("E00119")) {
				q="select grn_id,grn_dt_disp,grn_no,grn_lr_no,grn_lr_dt_disp,grn_transfer_no,grn_transfer_dt_disp,trantype,grn_company from v_GRN_HEADER where GRN_ins_usr_id='E00040' and GRN_APPR_STATUS='F' and GRN_LOC_ID=:empLoc order by GRN_NO";
				query  = em.createNativeQuery(q,Tuple.class);
				query.setParameter("empLoc", empLoc);
			}
			
			List<Tuple> tuples = query.getResultList();
			if (tuples != null && !tuples.isEmpty()) {
				for(Tuple t : tuples) {
					V_GRN_Header grnHeader=new V_GRN_Header();
					grnHeader.setGrn_id(Long.valueOf(t.get("grn_id",Integer.class)));
					grnHeader.setGrn_dt_disp(t.get("grn_dt_disp",String.class));
					grnHeader.setGrn_no(t.get("grn_no",String.class));
					grnHeader.setGrn_lr_no(t.get("grn_lr_no",String.class));
					grnHeader.setGrn_lr_dt_disp(t.get("grn_lr_dt_disp",String.class));
					grnHeader.setGrn_transfer_no(t.get("grn_transfer_no",String.class));
					grnHeader.setGrn_transfer_dt_disp(t.get("grn_transfer_dt_disp",String.class));
					grnHeader.setTrantype(t.get("trantype",String.class));
					grnHeader.setGrn_company(t.get("grn_company",String.class));
					list.add(grnHeader);
				}
			}
		} finally {
			if (em != null) { em.close(); }
		}
		
		map.put("loginId", loginId);
		map.put("list", list);
		return map;	
	}
	
	@Override
	public Map<String,Object> getGrnApprovalSelectedDetail(@RequestParam long grnId){
		System.out.println(grnId);
		Map<String, Object> map=new HashMap<>();
		EntityManager em = null;
		List<V_Grn_Details> list=new ArrayList<>();
		try {
			em = emf.createEntityManager();
			String q="select smp_prod_cd,smp_prod_name,batch_no,grnd_noofboxes,batch_expiry_dt_disp,batch_mfg_dt_disp,grnd_rate,grnd_qty,value from V_Grn_Details where GRND_GRN_ID=:grnId";
			Query query  = em.createNativeQuery(q,Tuple.class);
			query.setParameter("grnId", grnId);

			List<Tuple> tuples = query.getResultList();
			if (tuples != null && !tuples.isEmpty()) {
				for(Tuple t : tuples) {
					V_Grn_Details grnDetails=new V_Grn_Details();
					grnDetails.setSmp_prod_cd(t.get("smp_prod_cd",String.class));
					grnDetails.setSmp_prod_name(t.get("smp_prod_name",String.class));
					grnDetails.setBatch_no(t.get("batch_no",String.class));
					grnDetails.setGrnd_noofboxes(Long.valueOf(t.get("grnd_noofboxes",Integer.class)));
					grnDetails.setBatch_expiry_dt_disp(t.get("batch_expiry_dt_disp",String.class));
					grnDetails.setBatch_mfg_dt_disp(t.get("batch_mfg_dt_disp",String.class));
					grnDetails.setGrnd_rate(t.get("grnd_rate",BigDecimal.class));
					grnDetails.setGrnd_qty(t.get("grnd_qty",BigDecimal.class));
					grnDetails.setValue(t.get("value",BigDecimal.class));
					list.add(grnDetails);
				}
			}
		} finally {
			if (em != null) { em.close(); }
		}
		map.put("list", list);
		return map;
		
	}
	
	
	@Override
	public void updateDetailOnSelfApproveOfGRN(@RequestParam String empId,@RequestParam long grnId,@RequestParam String remark,HttpServletRequest request) {
		EntityManager em = null;
		System.out.println("Remark is "+remark);
		String ip_addr = request.getRemoteAddr();
		Date date=new Date();
		try {
			em = emf.createEntityManager();
			em.getTransaction().begin();
			String headerQuery="UPDATE GRN_HEADER set GRN_APPR_STATUS='F',GRN_mod_usr_id=:empId,GRN_mod_dt=:date,GRN_mod_ip_add=:ip_addr,REMARKS=:remark where grn_id=:grnId";
			em.createNativeQuery(headerQuery)
			.setParameter("grnId", grnId)
			.setParameter("date", date)
			.setParameter("ip_addr", ip_addr)
			.setParameter("empId", empId)
			.setParameter("remark",remark)
			.executeUpdate();	
			
			//newFilePath=
	        
	        String detailQuery="UPDATE GRN_DETAILS set GRND_IMAGE_PATH=:newFilePath where GRND_GRN_ID=:grnId";
			em.createNativeQuery(detailQuery)
			.setParameter("newFilePath", newFilePath)
			.setParameter("grnId", grnId)
			.executeUpdate();
			
			em.getTransaction().commit();
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
	}
	@Override
	public void updateDetailOnSelfDiscardOfGRN(@RequestParam String empId,@RequestParam long grnId,@RequestParam String remark,HttpServletRequest request) {
		EntityManager em = null;
		System.out.println("Remark is "+remark);
		String ip_addr = request.getRemoteAddr();
		Date date=new Date();
		try {
			em = emf.createEntityManager();
			em.getTransaction().begin();
			String query="update GRN_HEADER set GRN_APPR_STATUS='D',GRN_mod_usr_id=:empId,GRN_mod_dt=:date,GRN_mod_ip_add=:ip_addr,REMARKS=:remark where grn_id=:grnId";
			em.createNativeQuery(query)
			.setParameter("grnId", grnId)
			.setParameter("date", date)
			.setParameter("ip_addr", ip_addr)
			.setParameter("empId", empId)
			.setParameter("remark",remark)
			.executeUpdate();
			em.getTransaction().commit();
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
	}

	@Override
	public String uploadFile(MultipartFile file) {
		
		System.out.println("inside upload file");
		try {
			String rootPath=MedicoConstants.GRN_APPR_FILE_PATH;
			File dir = new File(rootPath);
			if (!dir.exists()) {dir.mkdirs();}
			
			File f=new File("file");
			String filename = file.getOriginalFilename().toString();
			System.out.println("orignoal file name:"+filename);
			String newFileString=dir.getAbsolutePath() + File.separator + file.getOriginalFilename();
			System.out.println(newFileString);
			 byte[] bytes = file.getBytes();
			BufferedOutputStream stream = new BufferedOutputStream(
	                new FileOutputStream(newFileString)); 
			stream.write(bytes);
	        stream.close();
	        
	        newFilePath=newFileString;
	        System.out.println("new file path is:"+newFileString);
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return newFilePath;
	}
	@Override
	public Object viewFile(@RequestParam long grnId) throws Exception {
		EntityManager em = null;
		System.out.println("grn id is:"+grnId);
		Map<String,Object> map=new HashMap<>();
		try {
			em = emf.createEntityManager();
			String q="select GRND_IMAGE_PATH from GRN_DETAILS  where GRND_GRN_ID=:grnId";
			Query query  = em.createNativeQuery(q,Tuple.class);
			query.setParameter("grnId", grnId);
	
			List<Tuple> tuples = query.getResultList();
			if (tuples != null && !tuples.isEmpty()) {
				for(Tuple t : tuples) {
					String filePath=t.get("GRND_IMAGE_PATH",String.class);
					File f=new File(filePath);
					String fileName=f.getName();
					map.put("fileName", fileName);
				}
			}
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
		
	}
	
	@Override
	public List getGrnDetailForGrnVoucherPrint(String sdate,String edate,String supId,String locId) {
		System.out.println("dates in repository is :"+sdate+".."+edate+"..."+supId+"..."+locId);
		EntityManager em = null;
		Map<String,Object> map=new HashMap<>();
		List<String> list=new ArrayList<>();
		String q;Query query;
		try {
			em = emf.createEntityManager();
			if(supId.equals("All")) {
				q="SELECT GH.GRN_ID,GH.GRN_NO,GH.GRN_DT FROM GRN_HEADER GH , GRN_DETAILS GD ,  SUPPLIER S   WHERE GH.GRN_LOC_ID =:locId  "
						+ "AND CONVERT(date,GH.GRN_DT,105) >= CONVERT(date,:sdate,105) "
						+ "AND CONVERT(date,GH.GRN_DT,105) <= CONVERT(date,:edate,105) "
						+ "AND GH.GRN_SUPPLIER_ID = S.SUP_ID  "
						+ "AND GH.GRN_ID = GD.GRND_GRN_ID AND GH.GRN_STATUS='A'  "
						+ "GROUP BY GH.GRN_ID,GH.GRN_NO,GH.GRN_DT  ORDER BY GH.GRN_NO";
				query  = em.createNativeQuery(q,Tuple.class);
				query.setParameter("sdate", sdate);
				query.setParameter("edate", edate);
				query.setParameter("locId", locId);
			}
			else {
			q="SELECT GH.GRN_ID,GH.GRN_NO,GH.GRN_DT FROM GRN_HEADER GH , GRN_DETAILS GD ,  SUPPLIER S   WHERE GH.GRN_LOC_ID =:locId "
					+ "AND GH.GRN_SUPPLIER_ID=:supId "
					+ "AND CONVERT(date,GH.GRN_DT,105)>=CONVERT(date,:sdate,105) "
					+ "AND CONVERT(date,GH.GRN_DT,105)<=CONVERT(date,:edate,105) "
					+ "AND GH.GRN_SUPPLIER_ID = S.SUP_ID  AND GH.GRN_ID = GD.GRND_GRN_ID AND GH.GRN_STATUS='A'  "
						+ "GROUP BY GH.GRN_ID,GH.GRN_NO,GH.GRN_DT  ORDER BY GH.GRN_NO";
				query  = em.createNativeQuery(q,Tuple.class);
				query.setParameter("sdate", sdate);
				query.setParameter("edate", edate);
				query.setParameter("supId", supId);
				query.setParameter("locId", locId);
			}
			
			List<Tuple> tuples = query.getResultList();
			if (tuples != null && !tuples.isEmpty()) {
				for(Tuple t : tuples) {
					String grnNo=t.get("GRN_NO",String.class);
					list.add(grnNo);
					System.out.println("Grn number is :"+grnNo);
				}
			}
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return list;
	}
	
}
