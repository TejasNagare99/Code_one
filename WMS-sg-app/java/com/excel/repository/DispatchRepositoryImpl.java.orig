package com.excel.repository;

import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.ParameterMode;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.persistence.StoredProcedureQuery;
import javax.persistence.Tuple;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import javax.servlet.http.HttpServletRequest;

import org.hibernate.Session;
import org.hibernate.jdbc.Work;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.excel.bean.ReportBean;
import com.excel.model.AllocationDetailList;
import com.excel.model.AutoDispatchDropdown;
import com.excel.model.DispatchHeaderData;
import com.excel.model.Dispatch_Detail;
import com.excel.model.Dispatch_Header;
import com.excel.model.Dispatch_Header_;
import com.excel.model.GenerateDispatchData;
import com.excel.model.GenerateDispatchDataCfaStock;
import com.excel.model.GenerateDispatchData_AllocType;
import com.excel.model.GrnDetails;
import com.excel.model.GrnDetails_;
import com.excel.model.ManualDispatchItemList;
import com.excel.model.ManualDispatchList;
import com.excel.model.ManualDispatchList_;
import com.excel.model.ManulDispatchProdListData;
import com.excel.model.MonthList;
import com.excel.model.P_iu_dispatch_java;
import com.excel.model.P_v_dispatch2_java;
import com.excel.model.Sum_Disp_Header;
import com.excel.model.Supplier;

@Repository
public class DispatchRepositoryImpl implements DispatchRepository {
	
	@Autowired private EntityManagerFactory emf;
	@PersistenceContext private EntityManager entityManager;
	
	@Override
	public AllocationDetailList getAllocationDetailList(String emp_id) throws Exception {
		EntityManager em = null;
		AllocationDetailList result = null;
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callAllocationDetailList");
			query.setParameter("pvemp_id", emp_id);
			result = (AllocationDetailList) query.getSingleResult();
		} finally {
			if (em != null) { em.close(); }
		}
		return result;
	}
	
	
	@SuppressWarnings("unchecked")
	@Override
	public List<MonthList> getMonthList(String tablename, String fieldlist, String search, String orderby) throws Exception {
		EntityManager em = null;
		List<MonthList> list = null;
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callMonthList");
			query.setParameter("tablename", tablename);
			query.setParameter("fieldlist", fieldlist);
			query.setParameter("search", search);
			query.setParameter("orderby", orderby);
			list = query.getResultList();
		} finally {
			if (em != null) { em.close(); }
		}
		return list;
	}
	
	@SuppressWarnings("unchecked")
	@Override
	public List<AutoDispatchDropdown> getAutoDispatchDropdown(String alloc_smp_id, String dispatchToLabel, String divId) throws Exception {
		EntityManager em = null;
		List<AutoDispatchDropdown> list= null;
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callAutoDispatchDropDown");
			query.setParameter("piSMP_ID", Long.parseLong(alloc_smp_id));
			query.setParameter("pcType", dispatchToLabel);
			query.setParameter("piFSTAFF_DIV_ID", Long.parseLong(divId));
			list = query.getResultList();
		} finally {
			if (em != null) { em.close(); }
		}
		return list;
	}
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	 public List<GenerateDispatchData> genAutoDispatch(String comp_cd, String fin_year, String period_cd, Long dsp_loc_id,
			    Long smp_id, Long pi_loc_id, Long pi_abm, Long pi_rbm, Long pi_stateId, Long pi_msr, String pend_alloc,
			    String action, String pvinsusr_id, Long pvinsip, Long pi_div_id, Long sample_rbm, Long sample_abm,
			    String sample_flag, String challan_msg, Long chalan_periodId, String req_lvl, Long zone_id,
			    String direct_to_pso_ind, boolean stock_at_cfa_ind) throws Exception {
		 	EntityManager em = null;
			List<GenerateDispatchData> list= null;
			System.out.println("Param : " + comp_cd + ":" + fin_year + ":" + period_cd + ":" + dsp_loc_id + ":" + smp_id
					+ ":" + pi_loc_id + ":" + pi_abm + ":" + pi_rbm + ":" + pi_stateId + ":" + pi_msr + ":" + pend_alloc
					+ ":" + action + ":" + pvinsusr_id + ":" + pvinsip + ":" + pi_div_id + ":" + sample_rbm + ":"
					+ sample_abm + ":" + sample_flag + ":" + challan_msg + ":" + chalan_periodId + ":" + req_lvl + ":"
					+ zone_id + "::::" + direct_to_pso_ind);
			try {
				em = emf.createEntityManager();
				StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callGenerateDispatchData");
				query.setParameter("pcDSP_COMPANY", comp_cd);
				query.setParameter("pcDSP_FIN_YEAR", fin_year);
				query.setParameter("pcDSP_PERIOD_CODE", period_cd);
				query.setParameter("piDSP_LOC_ID", dsp_loc_id);
				query.setParameter("piDSP_SMP_ID", smp_id);
				query.setParameter("pirlocid", pi_loc_id);
				query.setParameter("piabm", pi_abm);
				query.setParameter("pirbm", pi_rbm);
				query.setParameter("pistateid", pi_stateId);
				query.setParameter("pimsr", pi_msr);
				query.setParameter("pcpendalloc", pend_alloc);
				query.setParameter("pcaction", action);
				query.setParameter("pvinsusr_id", pvinsusr_id);
				query.setParameter("pvinsip", pvinsip.toString());
				query.setParameter("pidiv_id", pi_div_id);
				query.setParameter("pisamplerbm", sample_rbm);
				query.setParameter("pisampleabm", sample_abm);
				query.setParameter("pcsampleflg", sample_flag);
				query.setParameter("pvchallan_msg", challan_msg);
				query.setParameter("pvchallan_PERIOD_ID", chalan_periodId);
				query.setParameter("pvDSP_APPR_REQ", req_lvl);
				query.setParameter("pirzonid", zone_id);
				query.setParameter("Pdirect_to_pso_ind", direct_to_pso_ind);
				list = query.getResultList();
			} finally {
				if (em != null) { em.close(); }
			}
			return list;
	 }
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	 public List<GenerateDispatchDataCfaStock> genAutoDispatchCfaStock(String comp_cd, String fin_year, String period_cd, Long dsp_loc_id,
			    Long smp_id, Long pi_loc_id, Long pi_abm, Long pi_rbm, Long pi_stateId, Long pi_msr, String pend_alloc,
			    String action, String pvinsusr_id, Long pvinsip, Long pi_div_id, Long sample_rbm, Long sample_abm,
			    String sample_flag, String challan_msg, Long chalan_periodId, String req_lvl, Long zone_id,
			    String direct_to_pso_ind, boolean stock_at_cfa_ind) throws Exception {
		 	EntityManager em = null;
			List<GenerateDispatchDataCfaStock> list= null;
			try {
				em = emf.createEntityManager();
				StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callGenerateDispatchDataCfastock");
				query.setParameter("pcDSP_COMPANY", comp_cd);
				query.setParameter("pcDSP_FIN_YEAR", fin_year);
				query.setParameter("pcDSP_PERIOD_CODE", period_cd);
				query.setParameter("piDSP_LOC_ID", dsp_loc_id);
				query.setParameter("piDSP_SMP_ID", smp_id);
				query.setParameter("pirlocid", pi_loc_id);
				query.setParameter("piabm", pi_abm);
				query.setParameter("pirbm", pi_rbm);
				query.setParameter("pistateid", pi_stateId);
				query.setParameter("pimsr", pi_msr);
				query.setParameter("pcpendalloc", pend_alloc);
				query.setParameter("pcaction", action);
				query.setParameter("pvinsusr_id", pvinsusr_id);
				query.setParameter("pvinsip", pvinsip);
				query.setParameter("pidiv_id", pi_div_id);
				query.setParameter("pisamplerbm", sample_rbm);
				query.setParameter("pisampleabm", sample_abm);
				query.setParameter("pcsampleflg", sample_flag);
				query.setParameter("pvchallan_msg", challan_msg);
				query.setParameter("pvchallan_PERIOD_ID", chalan_periodId);
				query.setParameter("pvDSP_APPR_REQ", req_lvl);
				query.setParameter("pirzonid", zone_id);
				query.setParameter("Pdirect_to_pso_ind", direct_to_pso_ind);
				list = query.getResultList();
			} finally {
				if (em != null) { em.close(); }
			}
			return list;
	 }
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	 public List<String> getAutoDispatchDetailsUpdated(Long smp_id, Long disp_cycle, Long loc_id, Long div_id,
			    boolean stock_at_cfa_ind) throws Exception {
			EntityManager em = null;
			List<String> details = new LinkedList<>();
			try {
				em = emf.createEntityManager();
			    System.out.println("para:" + smp_id + ":" + disp_cycle + ":" + loc_id + ":" + div_id);
			    
			    Session session = em.unwrap(Session.class);
			    session.doWork(new Work() {
					
					@Override
					public void execute(Connection conn) throws SQLException {
						String SPsql = "";
						 if (stock_at_cfa_ind) {
								SPsql = "EXEC p_v_auto_dispatch_detail_cfastock ?,?,?,?";
							    } else {
								SPsql = "EXEC p_v_auto_dispatch_detail ?,?,?,?";
							    }
						PreparedStatement pstmt = conn.prepareStatement(SPsql);
						    pstmt.setLong(1, smp_id);
						    pstmt.setLong(2, disp_cycle);
						    pstmt.setLong(3, loc_id);
						    pstmt.setLong(4, div_id);
						    boolean results = pstmt.execute();
						    String columnName = "";
						    while (results) {
						    ResultSet rs = pstmt.getResultSet();
							ResultSetMetaData rsmd = rs.getMetaData();
							while (rs.next()) {
							    columnName = rsmd.getColumnName(1).trim();
							    if (columnName.equalsIgnoreCase("no_challan_gen")) {
							    	details.add(rs.getString("no_challan_gen"));
							    } else if (columnName.equalsIgnoreCase("disp_start_no")) {
									details.add(rs.getString("disp_start_no"));
									details.add(rs.getString("disp_end_no"));
							    } else if (columnName.equalsIgnoreCase("no_sum_disp")) {
									details.add("#");
									details.add(rs.getString("no_sum_disp"));
							    } else if (columnName.equalsIgnoreCase("sum_start_no")) {
									details.add(rs.getString("sum_start_no"));
									details.add(rs.getString("sum_end_no"));
							    }
							}
							results = pstmt.getMoreResults();
						    }
					}
				});
			   
			} catch (Exception e) {
			    throw e;
			} 
			return details;
		    }
	
	@SuppressWarnings("unchecked")
	@Override
	public List<ManualDispatchItemList> getdispatchProd_list(Long staff_id,Long smp_id) throws Exception {
		List<ManualDispatchItemList> list =null;
		EntityManager em = null;
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callManualDispatchItemList");
			query.setParameter("piFSTAFF_ID", staff_id);
			query.setParameter("piSMP_ID", smp_id);
			list = query.getResultList();
		} finally {
			if (em != null) { em.close(); }
		}
		return list;
	}
	
	@SuppressWarnings("unchecked")
	@Override
	public List<ManulDispatchProdListData> getdispatchProdDetails(String comp_cd,String dsp_year,String dsp_period_cd,Long dsp_loc,Long smp_id,
			Long prod_id,Long msr_id,String pend_alloc) throws Exception{
		List<ManulDispatchProdListData> list =null;
		EntityManager em = null;
		System.out.println("para::"+comp_cd+":"+dsp_year+":"+dsp_period_cd+":"+dsp_loc+":"+smp_id +":"+
				 prod_id+":"+ msr_id+":"+ pend_alloc);
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callManulDispatchProdListData");
			query.setParameter("pcDSP_COMPANY", comp_cd);
			query.setParameter("pcDSP_FIN_YEAR", dsp_year);
			query.setParameter("pcDSP_PERIOD_CODE", dsp_period_cd);
			query.setParameter("piDSP_LOC_ID", dsp_loc);
			query.setParameter("pismp_id", smp_id);
			query.setParameter("piprod_id", prod_id);
			query.setParameter("pimsr_id", msr_id);
			query.setParameter("pcpendalloc", pend_alloc);
			list = query.getResultList();
		} finally {
			if (em != null) { em.close(); }
		}
		return list;
	}
	
	@Override
	public List<P_iu_dispatch_java> saveManualDispatch(String comp_cd,String dsp_year,String dsp_period_cd,Long dsp_loc,Long dsp_alloc_id,Long smp_id,
			Long fstaff_id,Long div_id,Long recv_loc,Long dsp_state_id,String pend_alloc,String emp_id,String ip_addr,String dsp_status,
			Long dsp_cycle,Long dsp_id,Long prod_id,Long dsp_batch_id,BigDecimal disp_qty,BigDecimal disp_rate,
			Long dsp_dtl_alloc_id,Long dsp_alt_divid,Long sumdsp_id,String action,String status_flag,
			BigDecimal prv_smpqty,Long prv_allocid,Long prv_allocdtlid,String challan_msg,Long challan_period_id,String req_lvl,
			String direct_to_pso_ind) throws Exception {
		List<P_iu_dispatch_java> list =null;
		EntityManager em = null;
		System.out.println(comp_cd+":"+dsp_year+":"+dsp_period_cd+":"+dsp_loc+":"+dsp_alloc_id+":"+smp_id
				+":"+ fstaff_id+":"+div_id+":"+recv_loc+":"+dsp_state_id+":"+pend_alloc+":"+emp_id+":"+ip_addr+":"+dsp_status
				+":"+ dsp_cycle+":"+dsp_id+":"+prod_id+":"+dsp_batch_id+":"+disp_qty+":"+disp_rate
				+":"+ dsp_dtl_alloc_id+":"+dsp_alt_divid+":"+sumdsp_id+":"+action+":"+status_flag
				+":"+ prv_smpqty+":"+prv_allocid+":"+prv_allocdtlid+":"+challan_msg+":"+challan_period_id+":"+direct_to_pso_ind);
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callSaveManualDispatch");
			query.setParameter("pcDSP_COMPANY", comp_cd);
			query.setParameter("pcDSP_FIN_YEAR", dsp_year);
			query.setParameter("pcDSP_PERIOD_CODE", dsp_period_cd);
			query.setParameter("piDSP_LOC_ID", dsp_loc);
			query.setParameter("piDSP_ALLOC_ID", dsp_alloc_id);
			query.setParameter("piDSP_SMP_ID", smp_id);
			query.setParameter("piDSP_FSTAFF_ID", fstaff_id);
			query.setParameter("piDSP_DIV_ID", div_id);
			query.setParameter("piDSP_RECVG_LOC_ID", recv_loc);
			query.setParameter("piDSP_STATE_ID", dsp_state_id);
			query.setParameter("pcDSP_prev_alloc_flg", pend_alloc);
			query.setParameter("pvDSP_usr_id", emp_id);
			query.setParameter("pvDSP_ip_add", ip_addr);
			query.setParameter("pcDSP_status", dsp_status);
			query.setParameter("psiDISP_CYCLE", dsp_cycle);
			//query.setParameter("piDSP_ID_OUT", "");
			query.setParameter("piDSP_ID", dsp_id);
			query.setParameter("piDSPDTL_PROD_ID", prod_id);
			query.setParameter("piDSPDTL_BATCH_ID", dsp_batch_id);
			query.setParameter("pncDSPDTL_DISP_QTY", disp_qty);
			query.setParameter("pncDSPDTL_RATE", disp_rate);
			query.setParameter("piDSPDTL_ALLOCDTL_ID", dsp_dtl_alloc_id);
			query.setParameter("piDSPDTL_ALT_DIV_ID", dsp_alt_divid);
			query.setParameter("piSUMDSP_ID", sumdsp_id);
			//query.setParameter("piSUMDSP_ID_OUT", "");
			query.setParameter("pcaction", action);
			query.setParameter("pcStatus_flag", status_flag);
			query.setParameter("piprv_smpqty", prv_smpqty);
			query.setParameter("piprv_allocid", prv_allocid);
			query.setParameter("piprv_allocdtlid", prv_allocdtlid);
			query.setParameter("pvchallan_msg", challan_msg);
			query.setParameter("pvchallan_PERIOD_ID", challan_period_id);
			//query.setParameter("pvDSPchallan_no_out", "");
			//query.setParameter("pvSMchallan_no_out", "");
			query.setParameter("pvDSP_APPR_REQ", req_lvl);
			query.setParameter("Pdirect_to_pso_ind", direct_to_pso_ind);
			query.getOutputParameterValue("piDSP_ID_OUT");
			query.getOutputParameterValue("piSUMDSP_ID_OUT");
			query.getOutputParameterValue("pvDSPchallan_no_out");
			query.getOutputParameterValue("pvSMchallan_no_out");
			query.execute();
			
			list = new ArrayList<>();
			P_iu_dispatch_java obj = new P_iu_dispatch_java();
			obj.setPiDSP_ID_OUT(Long.parseLong(query.getOutputParameterValue("piDSP_ID_OUT").toString()));
			obj.setPiSUMDSP_ID_OUT(Long.parseLong(query.getOutputParameterValue("piSUMDSP_ID_OUT").toString()));
			obj.setPvDSPchallan_no_out(query.getOutputParameterValue("pvDSPchallan_no_out").toString());
			obj.setPvSMchallan_no_out(query.getOutputParameterValue("pvSMchallan_no_out").toString());
			list.add(obj);
			//list = query.getResultList();
			System.err.println("list:::"+list.size());
		} finally {
			if (em != null) { em.close(); }
		}
		return list;
	}
	
	
	@SuppressWarnings("unchecked")
	@Override
	public List<P_v_dispatch2_java> getDispatchedProdData(Long dsp_id,Long loc_id) throws Exception {
		List<P_v_dispatch2_java> list =null;
		EntityManager em = null;
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callP_v_dispatch2_java");
			query.setParameter("pidsp_id", dsp_id);
			query.setParameter("piloc_id", loc_id);
			list = query.getResultList();
		} finally {
			if (em != null) { em.close(); }
		}
		return list;
	}
	
	@Override
	public List<ManualDispatchList> getManualDispatchList(Long loc_SubComp_id, String user_divisions,
			String user_id, String user_type, long sum_dsp_id) throws Exception {
		List<ManualDispatchList> list = null;
		EntityManager em = null;
		try {
			List<Long> divList = new ArrayList<Long>();
			List<String> strList = new ArrayList<String>(Arrays.asList(user_divisions.split(",")));
			
			for(String number : strList){
				divList.add(Long.parseLong(number));
			}
			
			em = emf.createEntityManager();
			CriteriaBuilder builder = em.getCriteriaBuilder();
			
			CriteriaQuery<ManualDispatchList> criteriaQuery = builder.createQuery(ManualDispatchList.class);
			Root<ManualDispatchList> root = criteriaQuery.from(ManualDispatchList.class);
			if (!user_type.equalsIgnoreCase("S")) {
				criteriaQuery.select(root).where(
						builder.and(
								builder.equal(root.get(ManualDispatchList_.loc_SubComp_id), loc_SubComp_id),
								builder.equal(root.get(ManualDispatchList_.dsp_status), "A"),
								builder.equal(root.get(ManualDispatchList_.dsp_appr_status), "E"),
								builder.equal(root.get(ManualDispatchList_.dsp_ins_usr_id), user_id),
								root.get(ManualDispatchList_.dsp_div_id).in(divList)
								)
						).orderBy(builder.asc(root.get(ManualDispatchList_.dsp_challan_no)));
			}
			
			if (sum_dsp_id != 0) {
				criteriaQuery.select(root).where(
						builder.and(
								builder.equal(root.get(ManualDispatchList_.loc_SubComp_id), loc_SubComp_id),
								builder.equal(root.get(ManualDispatchList_.dsp_status), "A"),
								builder.equal(root.get(ManualDispatchList_.dsp_appr_status), "E"),
								builder.equal(root.get(ManualDispatchList_.dsp_sum_dsp_id), sum_dsp_id),
								root.get(ManualDispatchList_.dsp_div_id).in(divList)
								)
						).orderBy(builder.asc(root.get(ManualDispatchList_.dsp_challan_no)));
			}
			list = em.createQuery(criteriaQuery).getResultList();
			return list;
		}finally {
			if (em != null) {
				em.close();
			}
		}
	}
	
	@Override
	public List<Sum_Disp_Header> getSummaryChallanListByDiv(Long div_id, String user_id, Long loc_subComp_id, 
			int appr_level)throws Exception{
		System.out.println("emp id is"+user_id);
		System.out.println("div id is"+div_id);
		List<Sum_Disp_Header> list = new ArrayList<Sum_Disp_Header>();
		EntityManager em = null;
		try {
			em = emf.createEntityManager();
			StringBuffer sb = new StringBuffer();
			sb.append(" select distinct sumdsp_id as sumdsp_id, sumdsp_challan_no as sumdsp_challan_no from SUM_DISP_HEADER s left join dbo.location l  ");
			sb.append(" on s.SUMDSP_LOC_ID = l.loc_id left join dispatch_header d on s.sumdsp_id = d.dsp_sum_dsp_id  ");
			sb.append(" where SUMDSP_DIV_ID=:div_id and SUMDSP_status = 'A' ");
			sb.append(" and l.loc_SubComp_id = :loc_subComp_id  ");
			
			if(appr_level==0)
				sb.append(" and d.dsp_appr_status = 'E' and SUMDSP_ins_usr_id = :user_id");
			else
				sb.append(" and d.dsp_appr_status = 'F'");
			
			Query query = em.createNativeQuery(sb.toString(), Tuple.class);
			query.setParameter("div_id", div_id);
			query.setParameter("loc_subComp_id", loc_subComp_id);
			query.setParameter("user_id", user_id);
			List<Tuple> tuples = query.getResultList();
			Sum_Disp_Header sm = null;
			if (tuples != null && !tuples.isEmpty()) {
				for(Tuple t : tuples) {
					sm = new Sum_Disp_Header();
					sm.setSumdsp_id(Long.valueOf(t.get("sumdsp_id", Integer.class)));
					sm.setSumdsp_challan_no(t.get("sumdsp_challan_no", String.class));
					list.add(sm);
				}
			}
		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		} finally {
			if (em != null) { em.close(); }
		}
		return list;

	}
	
	@Override
	public Dispatch_Header getDispatchHeaderById(Long dsp_id) throws Exception {
		Dispatch_Header h = null;
		EntityManager em = null;
		try {
			em = emf.createEntityManager();
			h = em.find(Dispatch_Header.class, dsp_id);
		} finally {
			if(em != null) { em.close(); }
		}
		return h;
	}
	
	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void updateHeaderForApproval(String status, Long dsp_id, String user_name, Date appr_date) throws Exception{
		EntityManager em = null;
		try {
			em = emf.createEntityManager();
			StringBuffer buffer=new StringBuffer();
			buffer.append("update Dispatch_Header set dsp_appr_status=:status, dsp_mod_usr_id=:mod_user, ");
			buffer.append("dsp_mod_dt=:mod_date where dsp_id=:dsp_id ");
			Query query = em.createNativeQuery(buffer.toString());
			query.setParameter("status", status);
			query.setParameter("mod_user", user_name);
			query.setParameter("mod_date", appr_date);
			query.setParameter("dsp_id", dsp_id);
			query.executeUpdate();
			
		}catch(Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
			throw e;
		}finally {
			if(em != null) { em.close(); }
		}
//		if(status.equalsIgnoreCase("A")){
//			sb.append(" ,app_user_name=:app_user_name, appr_date=:appr_date ");
//		}else if(status.equalsIgnoreCase("D")){
//			sb.append(" ,rej_user_name=:rej_user_name, rej_date=:rej_date ");
//		}
	}
	
	@Override
	public List<ManualDispatchList> getManualDispatchListApproval(String user_id, String user_type, Long sum_dsp_id) throws Exception {
		List<ManualDispatchList> list = null;
		EntityManager em = null;
		
		try {
			em = emf.createEntityManager();
			CriteriaBuilder builder = em.getCriteriaBuilder();
			CriteriaQuery<ManualDispatchList> query = builder.createQuery(ManualDispatchList.class);
			Root<ManualDispatchList> root = query.from(ManualDispatchList.class);
			List<Predicate> predicates = new ArrayList<>();
			predicates.add(builder.equal(root.get(ManualDispatchList_.dsp_status), "A"));
			predicates.add(builder.equal(root.get(ManualDispatchList_.dsp_appr_status), "E"));
			predicates.add(builder.equal(root.get(ManualDispatchList_.dsp_ins_usr_id), user_id));
			if(sum_dsp_id!=null) {
				predicates.add(builder.equal(root.get(ManualDispatchList_.dsp_sum_dsp_id), sum_dsp_id));
			}
			
			query.where(predicates.toArray(new Predicate[0]))
				.orderBy(builder.desc(root.get(ManualDispatchList_.dsp_challan_no)));
			
			list = em.createQuery(query).getResultList();
			
		} catch (Exception e) {
			throw e;
		} finally {
			if(em != null) { em.close(); }
		}
		return list;
	}
	
	@Override
	public List<ReportBean> getProducts(long div_Id, int locfrmId, String stdt, String endt, String fstaff_id,
			String desg_id, String fstaffId_o, String deleted_inv, String emp_id,String emp_id1) throws Exception {
		EntityManager em = null;
		List<ReportBean> list = null;
		List<Tuple> tuples=null;
		try {
			em = emf.createEntityManager();
		    if (desg_id.equalsIgnoreCase("Y")) {
			if (div_Id == 0) {
			    StringBuffer qryString = new StringBuffer("select distinct dspdtl_prod_id,SMP_PROD_NAME ")
				    .append(" from  dispatch_header dh left join dispatch_detail dd on(dd.dspdtl_dsp_id=dh.dsp_id) ")
				    .append(" inner join smpitem pr on(dd.DSPDTL_PROD_ID=pr.SMP_PROD_ID) inner join sum_disp_header sh ")
				    .append(" on(sh.sumdsp_id=dh.dsp_sum_dsp_id)  ")
				    .append(" join location l on l.loc_id=dh.dsp_loc_id where");
			    if (!(fstaffId_o.equalsIgnoreCase("0"))) {
				qryString
					.append(" dd.DSPDTL_FSTAFF_ID in (select FSTAFF_ID  from fieldstaff where FSTAFF_DESIG= '")
					.append(fstaffId_o).append("') AND ");
			    }
			    qryString.append("  CONVERT(date,SH.SUMDSP_CHALLAN_DT,105)>=CONVERT(date,'").append(stdt)
				    .append("',105) ").append(" AND CONVERT(date,SH.SUMDSP_CHALLAN_DT,105)<=CONVERT(date,'")
				    .append(endt).append("',105) ");
			    qryString
				    .append(" AND DH.DSP_DIV_ID IN  (select ediv_div_id from am_m_emp_div_access where ediv_emp_id= '")
				    .append(emp_id1).append("') AND DH.DSP_STATUS= '").append(deleted_inv);
			    if (!emp_id.equalsIgnoreCase("0") && !emp_id.isEmpty()) {
				qryString.append("' AND dd.DSPDTL_FSTAFF_ID= '").append(emp_id);

				qryString.append("' and dh.DSP_LOC_ID = l.loc_id ");
				qryString.append(" and l.loc_SubComp_id = CASE WHEN ").append(locfrmId)
					.append("=0 THEN l.loc_SubComp_id ELSE ").append(locfrmId).append(" END");
				qryString.append(" order by SMP_PROD_NAME ");

			    } else {
				qryString.append("' and dh.DSP_LOC_ID = l.loc_id ");
				qryString.append(" and l.loc_SubComp_id = CASE WHEN ").append(locfrmId)
					.append("=0 THEN l.loc_SubComp_id ELSE ").append(locfrmId).append(" END");
				qryString.append(" order by SMP_PROD_NAME ");
			    }

			    Query query = em.createNativeQuery(qryString.toString(), Tuple.class);
			    tuples = query.getResultList();
			} else
			// =======================================================================================================
			{

			    StringBuffer qryString = new StringBuffer("select distinct dspdtl_prod_id,SMP_PROD_NAME ")
				    .append(" from  dispatch_header dh left join dispatch_detail dd on(dd.dspdtl_dsp_id=dh.dsp_id) ")
				    .append(" inner join smpitem pr on(dd.DSPDTL_PROD_ID=pr.SMP_PROD_ID) inner join sum_disp_header sh ")
				    .append(" on(sh.sumdsp_id=dh.dsp_sum_dsp_id) ")
				    .append(" join location l on l.loc_id=dh.dsp_loc_id where");
			    if (!(fstaffId_o.equalsIgnoreCase("0"))) {
				qryString
					.append(" dd.DSPDTL_FSTAFF_ID in (select FSTAFF_ID  from fieldstaff where FSTAFF_DESIG= '")
					.append(fstaffId_o).append("') AND ");
			    }
			    qryString.append("  CONVERT(date,SH.SUMDSP_CHALLAN_DT,105)>=CONVERT(date,'").append(stdt)
				    .append("',105) ").append(" AND CONVERT(date,SH.SUMDSP_CHALLAN_DT,105)<=CONVERT(date,'")
				    .append(endt).append("',105) ");
			    qryString.append(" AND DH.DSP_DIV_ID =").append(div_Id);
			    qryString.append(" AND DH.DSP_STATUS= '").append(deleted_inv);
			    if (!emp_id.equalsIgnoreCase("0") && !emp_id.isEmpty()) {
				qryString.append("' AND dd.DSPDTL_FSTAFF_ID= '").append(emp_id);

				qryString.append("' and dh.DSP_LOC_ID = l.loc_id ");
				qryString.append(" and l.loc_SubComp_id = CASE WHEN ").append(locfrmId)
					.append("=0 THEN l.loc_SubComp_id ELSE ").append(locfrmId).append(" END");
				qryString.append(" order by SMP_PROD_NAME ");

			    } else {
				qryString.append("' and dh.DSP_LOC_ID = l.loc_id ");
				qryString.append(" and l.loc_SubComp_id = CASE WHEN ").append(locfrmId)
					.append("=0 THEN l.loc_SubComp_id ELSE ").append(locfrmId).append(" END");
				qryString.append(" order by SMP_PROD_NAME ");
			    }

			    Query query = em.createNativeQuery(qryString.toString(), Tuple.class);
			    tuples = query.getResultList();

			}

		    } else {
			// ===================================================for
			// No====================================================
			if (div_Id == 0) {
			    StringBuffer qryString = new StringBuffer("select distinct dspdtl_prod_id,SMP_PROD_NAME ")
				    .append(" from  dispatch_header dh left join dispatch_detail dd on(dd.dspdtl_dsp_id=dh.dsp_id) ")
				    .append(" inner join smpitem pr on(dd.DSPDTL_PROD_ID=pr.SMP_PROD_ID) inner join sum_disp_header sh ")
				    .append(" on(sh.sumdsp_id=dh.dsp_sum_dsp_id) ")
				    .append(" join location l on l.loc_id=dh.dsp_loc_id where");
			    if (!(fstaff_id.equalsIgnoreCase("0"))) {
				qryString
					.append(" dd.DSPDTL_FSTAFF_ID in (select FSTAFF_ID  from fieldstaff where FSTAFF_LEVEL_CODE= '")
					.append(fstaff_id).append("') AND ");
			    }
			    qryString.append("  CONVERT(date,SH.SUMDSP_CHALLAN_DT,105)>=CONVERT(date,'").append(stdt)
				    .append("',105) ").append(" AND CONVERT(date,SH.SUMDSP_CHALLAN_DT,105)<=CONVERT(date,'")
				    .append(endt).append("',105) ");

			    qryString
				    .append(" AND DH.DSP_DIV_ID IN  (select ediv_div_id from am_m_emp_div_access where ediv_emp_id= '")
				    .append(emp_id1).append("') AND DH.DSP_STATUS= '").append(deleted_inv);
			    if (!emp_id.equalsIgnoreCase("0") && !emp_id.isEmpty()) {
				qryString.append("' AND dd.DSPDTL_FSTAFF_ID= '").append(emp_id);

				qryString.append("' and dh.DSP_LOC_ID = l.loc_id ");
				qryString.append(" and l.loc_SubComp_id = CASE WHEN ").append(locfrmId)
					.append("=0 THEN l.loc_SubComp_id ELSE ").append(locfrmId).append(" END");
				qryString.append(" order by SMP_PROD_NAME ");

			    } else {
				qryString.append("' and dh.DSP_LOC_ID = l.loc_id ");
				qryString.append(" and l.loc_SubComp_id = CASE WHEN ").append(locfrmId)
					.append("=0 THEN l.loc_SubComp_id ELSE ").append(locfrmId).append(" END");
				qryString.append(" order by SMP_PROD_NAME ");
			    }

			    Query query = em.createNativeQuery(qryString.toString(), Tuple.class);
			    tuples = query.getResultList();
			}
			// =======================================================================================================
			else {
			    StringBuffer qryString = new StringBuffer("select distinct dspdtl_prod_id,SMP_PROD_NAME ")
				    .append(" from  dispatch_header dh left join dispatch_detail dd on(dd.dspdtl_dsp_id=dh.dsp_id) ")
				    .append(" inner join smpitem pr on(dd.DSPDTL_PROD_ID=pr.SMP_PROD_ID) inner join sum_disp_header sh ")
				    .append(" on(sh.sumdsp_id=dh.dsp_sum_dsp_id) ")
				    .append(" join location l on l.loc_id=dh.dsp_loc_id where");
			    if (!(fstaff_id.equalsIgnoreCase("0"))) {
				qryString
					.append(" dd.DSPDTL_FSTAFF_ID in (select FSTAFF_ID  from fieldstaff where FSTAFF_LEVEL_CODE= '")
					.append(fstaff_id).append("') AND ");
			    }
			    qryString.append("  CONVERT(date,SH.SUMDSP_CHALLAN_DT,105)>=CONVERT(date,'").append(stdt)
				    .append("',105) ").append(" AND CONVERT(date,SH.SUMDSP_CHALLAN_DT,105)<=CONVERT(date,'")
				    .append(endt).append("',105) ");

			    qryString.append(" AND DH.DSP_DIV_ID =").append(div_Id);
			    qryString.append(" AND DH.DSP_STATUS= '").append(deleted_inv);
			    if (!emp_id.equalsIgnoreCase("0") && !emp_id.isEmpty()) {
				qryString.append("' AND dd.DSPDTL_FSTAFF_ID= '").append(emp_id);

				qryString.append("' and dh.DSP_LOC_ID = l.loc_id ");
				qryString.append(" and l.loc_SubComp_id = CASE WHEN ").append(locfrmId)
					.append("=0 THEN l.loc_SubComp_id ELSE ").append(locfrmId).append(" END");
				qryString.append(" order by SMP_PROD_NAME ");

			    } else {
				qryString.append("' and dh.DSP_LOC_ID = l.loc_id ");
				qryString.append(" and l.loc_SubComp_id = CASE WHEN ").append(locfrmId)
					.append("=0 THEN l.loc_SubComp_id ELSE ").append(locfrmId).append(" END");
				qryString.append(" order by SMP_PROD_NAME ");
			    }
			    
			    Query query = em.createNativeQuery(qryString.toString(), Tuple.class);
			    tuples = query.getResultList();
			}

		    }
		    list=new ArrayList<ReportBean>();
		    if (tuples != null && !tuples.isEmpty()) {
				for(Tuple t : tuples) {
					ReportBean bean=new ReportBean();
					bean.setProductId(Long.valueOf(t.get("dspdtl_prod_id", Integer.class)));
					bean.setProductName(t.get("SMP_PROD_NAME", String.class));
					list.add(bean);
				}
			}

		} finally {
			if (em != null) { em.close(); }
		}
		
		return list;
	}

	@Override
	public DispatchHeaderData getDispatchedHeaderData(Long dsp_id,Long loc_id) throws Exception {
		EntityManager em = null;
		DispatchHeaderData result = null;
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("p_v_dispatch1_java");
			query.setParameter("dsp_id", dsp_id);
			query.setParameter("loc_id", loc_id);
			result = (DispatchHeaderData) query.getSingleResult();
		} finally {
			if (em != null) { em.close(); }
		}
		return result;
	}


	@Override
	public Dispatch_Header getDispatchHeaderByChallanNo(String challan_no) throws Exception {
		EntityManager em = null;
		Dispatch_Header header = null;
		try {
			em = emf.createEntityManager();
			CriteriaBuilder builder = em.getCriteriaBuilder();
			CriteriaQuery<Dispatch_Header> criteriaQuery = builder.createQuery(Dispatch_Header.class);
			Root<Dispatch_Header> root = criteriaQuery.from(Dispatch_Header.class);
			criteriaQuery.select(root)
			.where(builder.equal(root.get(Dispatch_Header_.dspChallanNo), challan_no));
			header = em.createQuery(criteriaQuery).getResultList().get(0);
		} finally {
			if (em != null) { em.close(); }
		}
		return header;
	}


	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void updateDispatchHeaderForSelfApproval(String challanNumber, Date date, String ip_address,String empId) {
		String query="update dispatch_header set Dsp_appr_status='F', Dsp_mod_dt=:date,Dsp_mod_ip_add=:ip_addr ,Dsp_mod_usr_id=:empId where dsp_challan_no=:challanNumber";
	
		entityManager.createNativeQuery(query)
			.setParameter("challanNumber", challanNumber)
			.setParameter("date", date)
			.setParameter("ip_addr", ip_address)
			.setParameter("empId", empId).executeUpdate();
	}
	
//	@Override
//	public Map<String,Object>  getDivisionForDispatchApproval() {
//		Map<String,Object> map=new HashMap<>();
//		List<String> divNameList=new ArrayList<>();
//		
//		String q="select * from v_EMP_DIV_Access where DIV_status='A' and EMP_ID='E00040'";
//		
//		EntityManager em =  emf.createEntityManager();
//		Query query = em.createNativeQuery(q, Tuple.class);
//		List<Tuple> tuples = query.getResultList();
//		if (tuples != null && !tuples.isEmpty()) {
//			for(Tuple t : tuples) {
//				String s=t.get("div_disp_nm", String.class);
//				divNameList.add(s);
//			}
//		}
//		map.put("divNameList", divNameList);
//		return map;	
//	}
	
	
	
	@Override
	public Object getHeaderForDispatchApproval(@RequestParam String ChallanNo) {
		System.out.println(ChallanNo);
		List<ManualDispatchList> manualDispatchList=new ArrayList<>();
		//List<ManualDispatchList> challanDetailList=new ArrayList<>();
		List<Object> challanDetailList=new ArrayList<>();
		Map<String,Object> mapList=new HashMap<>();
		List<String> challanNumberList = new ArrayList<>();
		int dspId = 0;
		EntityManager em = null;
		em = emf.createEntityManager();
		String q="select d.dsp_id,alloc_policy_name, fstaff_display_name, m.sumdsp_disp_cycle, m.dsp_dt, m.dsp_div_id,division,d.dsp_cycle, d.DSP_CHALLAN_NO from v_manual_dispatch_list m , Dispatch_header d where d.DSP_SUM_CHALLAN_NO=:ChallanNo and d.DSP_ID=m.DSP_ID";
		Query query = em.createNativeQuery(q, Tuple.class);
		query.setParameter("ChallanNo", ChallanNo);
		List<Tuple> tuples = query.getResultList();
		if (tuples != null && !tuples.isEmpty()) {
			challanDetailList = new ArrayList<>();
			for (Tuple t : tuples) {
				Map<String,Object> map=new HashMap<>();
				challanNumberList.add(t.get("dsp_challan_no",String.class));
				dspId=t.get("dsp_id",Integer.class);
				map.put("dsp_cycle", t.get("dsp_cycle",Integer.class));
				map.put("alloc_policy_name", t.get("alloc_policy_name",String.class));
				map.put("division", t.get("division",String.class));
				map.put("sumdsp_disp_cycle",t.get("sumdsp_disp_cycle",Integer.class));
				map.put("dsp_challan_no",t.get("dsp_challan_no",String.class));
				map.put("dsp_dt",t.get("dsp_dt",String.class));
				map.put("fstaff_display_name", t.get("fstaff_display_name",String.class));
				challanDetailList.add(map);
			}
			
		}
		mapList.put("dspId", dspId);
		mapList.put("challanNumberList", challanNumberList);
		mapList.put("challanDetailList", challanDetailList);
		return mapList;
	}
	
	
	@Override
	public Map<String,Object>  getDetailForDispatchApproval(@RequestParam int dspId) {
		System.out.println("dsp id in spring boot : "+dspId);
		Map<String,Object> mapList=new HashMap<>();;
		List<Object> detailList=new ArrayList<>();
		EntityManager em = null;
		em = emf.createEntityManager();

		String q="select SMP_PROD_NAME as product_name, batch_no, CONVERT(varchar(10),BATCH_EXPIRY_DT,103) as exp_dt, DSPDTL_DISP_QTY as qty from dbo.Dispatch_detail left join smpitem on DSPDTL_PROD_ID=SMP_PROD_ID left join smpbatch  on DSPDTL_BATCH_ID=batch_id where DSPDTL_DSP_ID=:dspId";
		Query query = em.createNativeQuery(q, Tuple.class);
		query.setParameter("dspId", dspId);
		List<Tuple> tuples = query.getResultList();
		Map<String,Object> map = null;
		if (tuples != null && !tuples.isEmpty()) {
			for (Tuple t : tuples) {
				map=new HashMap<>();
				String prodName=t.get("product_name",String.class);
				System.out.println(prodName);
				map.put("product_name", t.get("product_name",String.class));
				map.put("batch_no", t.get("batch_no",String.class));
				map.put("exp_dt", t.get("exp_dt",String.class));
				map.put("qty", t.get("qty",BigDecimal.class));
				detailList.add(map);
				
			}
			mapList.put("detailList", detailList);
		}
		
		return mapList;	
	}
	
	
	@Override
	public void updateDispatchHeaderForDispatchSelfDiscard(@RequestParam String empId,  @RequestParam List<String> challanNumberList,HttpServletRequest request) {
		EntityManager em = emf.createEntityManager();
		System.out.println(challanNumberList);
		em.getTransaction().begin();
		for(int i=0;i<challanNumberList.size();i++) {
			String challanNumber=challanNumberList.get(i);
			System.out.println(challanNumber);
			Date date=new Date();
			String ip_addr = request.getRemoteAddr();
			String query="update dispatch_header set Dsp_appr_status='D', Dsp_mod_dt=:date,Dsp_mod_ip_add=:ip_addr ,Dsp_mod_usr_id=:empId where dsp_challan_no=:challanNumber";
			
			em.createNativeQuery(query).
					setParameter("challanNumber", challanNumber)
					.setParameter("date", date)
					.setParameter("ip_addr", ip_addr)
					.setParameter("empId", empId).executeUpdate();
			em.getTransaction().commit();
		}	
		System.out.println("Approve status changed on discard");
	}


	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void updateDispatchHeaderForDispatchSelfApproval(String empId,List<String> challanNumberList,HttpServletRequest request) {
		EntityManager em = emf.createEntityManager();
		System.out.println("challan no list is : "+challanNumberList);
		try {
			em.getTransaction().begin();
			for(int i=0;i<challanNumberList.size();i++) {
				String challanNumber=challanNumberList.get(i);
				System.out.println(challanNumber);
				Date date=new Date();
				String ip_addr = request.getRemoteAddr();
				String query="update dispatch_header set Dsp_appr_status='F', Dsp_mod_dt=:date,Dsp_mod_ip_add=:ip_addr ,Dsp_mod_usr_id=:empId where dsp_challan_no=:challanNumber";
				
				em.createNativeQuery(query)
					.setParameter("challanNumber", challanNumber)
					.setParameter("date", date)
					.setParameter("ip_addr", ip_addr)
					.setParameter("empId", empId).executeUpdate();
				
			}	
			em.getTransaction().commit();
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
	}


	@Override
	public List<GenerateDispatchData_AllocType> genAutoDispatchAllocType(String comp_cd, String fin_year,
			String period_cd, Long dsp_loc_id, Long smp_id, Long pi_loc_id, Long pi_abm, Long pi_rbm, Long pi_stateId,
			Long pi_msr, String pend_alloc, String action, String pvinsusr_id, Long pvinsip, Long pi_div_id,
			Long sample_rbm, Long sample_abm, String sample_flag, String challan_msg, Long chalan_periodId,
			String req_lvl, Long zone_id, String direct_to_pso_ind, boolean stock_at_cfa_ind,String allocType) throws Exception {
	 	EntityManager em = null;
		List<GenerateDispatchData_AllocType> list= null;
		System.out.println("Param : " + comp_cd + ":" + fin_year + ":" + period_cd + ":" + dsp_loc_id + ":" + smp_id
				+ ":" + pi_loc_id + ":" + pi_abm + ":" + pi_rbm + ":" + pi_stateId + ":" + pi_msr + ":" + pend_alloc
				+ ":" + action + ":" + pvinsusr_id + ":" + pvinsip + ":" + pi_div_id + ":" + sample_rbm + ":"
				+ sample_abm + ":" + sample_flag + ":" + challan_msg + ":" + chalan_periodId + ":" + req_lvl + ":"
				+ zone_id + "::::" + direct_to_pso_ind);
		try {
			em = emf.createEntityManager();
			StoredProcedureQuery query  = em.createNamedStoredProcedureQuery("callGenerateDispatchDataAllocType");
			query.setParameter("pcDSP_COMPANY", comp_cd);
			query.setParameter("pcDSP_FIN_YEAR", fin_year);
			query.setParameter("pcDSP_PERIOD_CODE", period_cd);
			query.setParameter("piDSP_LOC_ID", dsp_loc_id);
			query.setParameter("piDSP_SMP_ID", smp_id);
			query.setParameter("pirlocid", pi_loc_id);
			query.setParameter("piabm", pi_abm);
			query.setParameter("pirbm", pi_rbm);
			query.setParameter("pistateid", pi_stateId);
			query.setParameter("pimsr", pi_msr);
			query.setParameter("pcpendalloc", pend_alloc);
			query.setParameter("pcaction", action);
			query.setParameter("pvinsusr_id", pvinsusr_id);
			query.setParameter("pvinsip", pvinsip.toString());
			query.setParameter("pidiv_id", pi_div_id);
			query.setParameter("pisamplerbm", sample_rbm);
			query.setParameter("pisampleabm", sample_abm);
			query.setParameter("pcsampleflg", sample_flag);
			query.setParameter("pvchallan_msg", challan_msg);
			query.setParameter("pvchallan_PERIOD_ID", chalan_periodId);
			query.setParameter("pvDSP_APPR_REQ", req_lvl);
			query.setParameter("pirzonid", zone_id);
			query.setParameter("Pdirect_to_pso_ind", direct_to_pso_ind);
			query.setParameter("PALLOC_TYPE", allocType);
			list = query.getResultList();
		} finally {
			if (em != null) { em.close(); }
		}
		return list;
 }


	@Override
	public List<Dispatch_Detail> getDtlListByHdrId(Long dspdtl_dsp_id, String status) throws Exception {
		List<Dispatch_Detail> list = null;
		try {
			StringBuffer sb = new StringBuffer();
			sb.append("from Dispatch_Detail d where dspdtlDspId=:dspdtlDspId and dspdtl_status=:dspdtl_status order by dspdtlId");
			Query query = entityManager.createQuery(sb.toString(),Dispatch_Detail.class);
			query.setParameter("dspdtlDspId", dspdtl_dsp_id);
			query.setParameter("dspdtl_status", status);
			list= query.getResultList();
		} finally {
		}
		return list;
	}


	@Override
	@Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
	public void deleteDispatchRecord(Long dsp_id, String emp_id, String ip_add, String status) throws Exception {
		StoredProcedureQuery query = entityManager.createStoredProcedureQuery("p_d_dispatch");
		query.registerStoredProcedureParameter("action", String.class, ParameterMode.IN);
		query.registerStoredProcedureParameter("dsp_id", String.class, ParameterMode.IN);
		query.registerStoredProcedureParameter("emp_id", String.class, ParameterMode.IN);
		query.registerStoredProcedureParameter("ip_add", Long.class, ParameterMode.IN);
		query.registerStoredProcedureParameter("status", Long.class, ParameterMode.IN);
		
		query.setParameter("action","D");
		query.setParameter("dsp_id",dsp_id);
		query.setParameter("emp_id", emp_id);
		query.setParameter("ip_add", ip_add);
		query.setParameter("status", status);
		query.execute();
	}


	
}
