package com.excel.restcontroller;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.excel.bean.GRNBean;
import com.excel.model.GrnDetails;
import com.excel.model.GrnHeader;
import com.excel.model.Location;
import com.excel.model.V_Grn_Details;
import com.excel.repository.CalculateGstRepository;
import com.excel.repository.GRNDetailRepository;
import com.excel.repository.GrnRepository;
import com.excel.service.BatchMasterService;
import com.excel.service.BinMasterService;
import com.excel.service.DivisionMasterService;
import com.excel.service.FieldStaffService;
import com.excel.service.GRNService;
import com.excel.service.LocationService;
import com.excel.service.ParameterService;
import com.excel.service.PeriodMasterService;
import com.excel.service.ProductMasterService;
import com.excel.service.SamplProdGroupService;
import com.excel.service.SupplierService;
import com.excel.service.UserMasterService;
import com.excel.service.V_GRN_HeaderService;
import com.excel.utility.MedicoConstants;

@RestController
@RequestMapping("/rest")
public class GrnRestController implements MedicoConstants {
	
	@Autowired LocationService locationService;
	@Autowired DivisionMasterService divisionmasterService;
	@Autowired SamplProdGroupService samplprodgroupservice;
	@Autowired BinMasterService binMasterService;
	@Autowired UserMasterService userMasterService;
	@Autowired ParameterService parameterService;
	@Autowired SupplierService supplierService;
	@Autowired ProductMasterService productMasterService;
	@Autowired PeriodMasterService periodMasterService;
	@Autowired GRNService grnService;
	@Autowired FieldStaffService fieldStaffService;
	@Autowired BatchMasterService batchMasterService;
	@Autowired V_GRN_HeaderService v_GRN_HeaderService;
	@Autowired GrnRepository grnRepository;
	

	@GetMapping("/get-data-for-grn-entry")
	public Map<String, Object> getDataForGrnEntry(@RequestParam String empId,
			HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		try {
			//String companyCode = session.getServletContext().getAttribute(COMPANY_CODE).toString();
			Location location = this.locationService.getLocationNameByEmployeeId(empId);
			
			map.put("recLocName", location.getLoc_nm());
			map.put("subCompId", location.getLoc_subcomp_id());
			map.put("locId", location.getLoc_id());
			map.put("divistionList", this.divisionmasterService.getStandardDivisionList());
			map.put("sampleProductList", this.samplprodgroupservice.getAllSamplProducts());
			map.put("binMasterList", this.binMasterService.getBinListByLocId(location.getLoc_id()));
			map.put("allowInd", this.userMasterService.getAllowBatchCreateInd(empId));
			Date today = new Date();
			/*
			Long grnDate = 0L;
			Period period = this.periodMasterService.getPeriodMasterByCompany(companyCode);
			SimpleDateFormat dateFormat = new SimpleDateFormat("dd/MM/yyyy");
			Date taskDate = MedicoResources.convert_DD_MM_YYYY_toDate(period.getPeriod_end_date());
			System.out.println("today"+ today);
			System.out.println("taskDate"+ taskDate);
			if (today.compareTo(taskDate) > 0) {
				grnDate = taskDate.getTime();
			    System.out.println("INSIDE IFFFF::::::" + grnDate);
			} else {
				grnDate = today.getTime();
			    System.out.println("INSIDE ELSEEEE::::::" + grnDate);
			}*/
			
			map.put("grnDate", today.getTime());
			map.put("grnMaxDate", today.getTime());
			map.put("lrDate", today.getTime());
			map.put("PODate", today.getTime());
			map.put("grnTypes", this.parameterService.getGrnTypes());
			map.put("productTypes", this.parameterService.getProductTypeList());
			map.put("stockTypes", this.parameterService.getStockTypes());

		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}
	
	@GetMapping("/get-supplier-types-by-grn-type")
	public Map<String, Object> getSupplierTypesbyGrnType(@RequestParam String grnType, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		try {
			map.put("supplierTypes", this.parameterService.getSupplierTypeByGrnType(grnType));
		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}
	
	@GetMapping("/get-suppliers-by-supplier-type")
	public Map<String, Object> getSupplierBySupplierTypes(@RequestParam String supplierType, @RequestParam Long locId, @RequestParam Long subCompId, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		System.out.println("supplierType::"+supplierType);
		try {
			map.put("suppliers", this.supplierService.getSuppliersBySupplierType(supplierType, locId, subCompId));
		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}
	
	@GetMapping("/get-product-list-by-prod-type")
	public Map<String, Object> getProductListForGRN(@RequestParam Long subCompId, @RequestParam Long prodType, @RequestParam Long prodGroup, @RequestParam Long divId, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		try {
			System.out.println( subCompId+ prodType+ prodGroup+ divId);
			String companyCode = session.getServletContext().getAttribute(COMPANY_CODE).toString();
			map.put("products", this.productMasterService.getProductListForGRN(companyCode.trim(), subCompId, prodType, prodGroup, divId));
		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}	

	@GetMapping("/get-product-details-by-id")
	public Map<String, Object> getProductDetailsByProductId(@RequestParam Long prodId, @RequestParam Long locId, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		try {
			String companyCode = session.getServletContext().getAttribute(COMPANY_CODE).toString();
			map.put("batchList", this.productMasterService.getProductDetailByProdId(companyCode, locId, prodId));
		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}
	
	@PostMapping("/save-grn")
	public Map<String, Object> saveGRN(@RequestBody GRNBean bean, HttpSession session, HttpServletRequest request) {
		Map<String, Object> map = new HashMap<>();
		map.put(DATA_SAVED, true);
		try {
			java.util.Date utilDate = new java.util.Date();
	        System.out.println("Util date in Java : " + utilDate);
	 
	        // contains only date information without time
	        java.sql.Date sqlDate = new java.sql.Date(utilDate.getTime());
	        System.out.println("SQL date in Java : " + sqlDate);
			
			bean.setIpAddress(request.getRemoteAddr());
			String companyCode = session.getServletContext().getAttribute(COMPANY_CODE).toString();
			bean.setCompanyCode(companyCode);
			Map<String, Object> grnMap = grnService.saveGRN(bean);
			map.put(DATA_SAVED, true);
			if(bean.isModifyHeader())
				map.put(RESPONSE_MESSAGE, "GRN updated Successfully!");
			else if(bean.isModifyDetails())
				map.put(RESPONSE_MESSAGE, "GRN updated Successfully!");
			else if(bean.getGrnId() != null && bean.getGrnId().compareTo(0L) > 0)
				map.put(RESPONSE_MESSAGE, "Record Added Successfully!");
			else
				map.put(RESPONSE_MESSAGE, "GRN Saved Successfully!");
			map.put("headerId", grnMap.get("headerId"));
			map.put("grnDetailId", grnMap.get("grnDetailId"));
			map.put("grnNumber", grnMap.get("grnNumber"));
			map.put("grnValue", grnMap.get("grnValue"));
			if(bean.getSaveMode().equals(MODIFY_MODE))
				map.put("grnListForModify", this.v_GRN_HeaderService.getObjectById(bean.getGrnId()));

			//map.put("grnId", bean.getDcrId());
			//map.put("DCR_DETAIL_ID", bean.getRunningDcrDetailId());
		} catch(Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
			map.put(DATA_SAVED, false);
			map.put(RESPONSE_MESSAGE, "Error Occurred !! Error Code : "+new CodifyErrors().getErrorCode(e));
		}
		return map;
	}
	
	@GetMapping("/get-field-staff-by-div-id")
	public Map<String, Object> getFieldStaffByDivId(@RequestParam Long divId, @RequestParam boolean hasResigned, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		try {
			String companyCode = session.getServletContext().getAttribute(COMPANY_CODE).toString();
			map.put("fieldList", this.fieldStaffService.getFieldStaffsByEmpIdAndHasResigned(divId, hasResigned, companyCode));
		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}
	
	@GetMapping("/get-grn-view-by-div-id")
	public Map<String, Object> getGrnViewByDivId(@RequestParam Long grnId, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		try {
			List<V_Grn_Details> list =this.grnService.getGrnDetailViewByGrnId(grnId);//17597L
			map.put("grnList", list);
			map.put("prodGrpIds", this.productMasterService.getProdListByProdIds(list != null && list.size() > 0 ? list.stream().map(e -> new Long(e.getGrnd_prod_id())).collect(Collectors.toList()) : new ArrayList<>()));//17597L
		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}	

	@GetMapping("/check-if-batch-exist-in-grn-detail")
	public Map<String, Object> checkIfBatchExistInGrndetails(@RequestParam Long grnId, @RequestParam Long prodId, Long batchId, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		try {
			map.put("isBatchPresentInGrndetail", this.grnService.checkIfBatchExistsInGrnDetail(grnId, prodId, batchId));
		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}
	
	@GetMapping("/check-if-batch-number-exist")
	public Map<String, Object> getBatchByBatchNumber(@RequestParam String batchNumber, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		try {
			map.put("isBatchPresent", this.batchMasterService.getSmpBatchByBatchNumbar(batchNumber));
		} catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}
	
	@GetMapping("/delete-grn-detail-by-detail-id")
	public Map<String, Object> deleteGrnDetailById(@RequestParam Long grnDetailId, @RequestParam String empId, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		map.put(DATA_SAVED, true);
		try {			
			map.put("grnValue", this.grnService.deleteGrnDetailById(grnDetailId, empId));
			map.put(RESPONSE_MESSAGE, "Record Deleted Successfully.");
		} catch(Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
			map.put(DATA_SAVED, false);
			map.put(RESPONSE_MESSAGE, "Error Occurred !! Error Code : "+new CodifyErrors().getErrorCode(e));
		}
		return map;
	}
	
	@GetMapping("/get-grn-list-for-modify")
	public Map<String, Object> getGrnListForModify(@RequestParam String empId, @RequestParam String fromDate, @RequestParam String toDate, HttpSession session) {
		Map<String, Object> map = new HashMap<>();
		try {
			String companyCode = session.getServletContext().getAttribute(COMPANY_CODE).toString();
			Location location = this.locationService.getLocationNameByEmployeeId(empId);
			map.put("grnListForModify", this.v_GRN_HeaderService.getGrnListByLocId(location.getLoc_id(), companyCode, empId, fromDate, toDate));
		} catch(Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;
	}
	
	@GetMapping("/get-user-div-by-fs-id")
	public Long getUSerDivByFsId(@RequestParam Long fsId, HttpSession session) {
		try {
			return this.fieldStaffService.getDivIdByFsId(fsId);
		} catch(Exception e) {
		
		e.p
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return null;
	}
	
	
	
	
	@GetMapping("/get-grn-approval-header-detail")
	public Map<String, Object> getGrnApprovalHeaderDetail(@RequestParam String empId, @RequestParam String empLoc){
		Map<String, Object> map=new HashMap<>();
		try {
			map=grnService.getGrnApprovalHeaderDetail(empId, empLoc);
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;	
	}

	@GetMapping("/get-grn-approval-selected-detail")
	public Map<String,Object> getGrnApprovalSelectedDetail(@RequestParam long grnId){
		Map<String, Object> map=new HashMap<>();
		try {
			map=this.grnService.getGrnApprovalSelectedDetail(grnId);
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
		return map;	
	}
	@PostMapping("/uploadFile")
	public String uploadFile(@RequestParam MultipartFile file) throws Exception {
		String newFilePath = grnService.uploadFile(file);
		return newFilePath;
	}

	@GetMapping("/updateDetailOnSelfApproveOfGRN")
	public void updateDetailOnSelfApproveOfGRN(@RequestParam String empId,@RequestParam long grnId,@RequestParam String remark,HttpServletRequest request) {
		try {
			grnService.updateDetailOnSelfApproveOfGRN(empId, grnId, remark, request);;
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
	}
	@GetMapping("/updateDetailOnSelfDiscardOfGRN")
	public void updateDetailOnSelfDiscardOfGRN(@RequestParam String empId,@RequestParam long grnId,@RequestParam String remark,HttpServletRequest request) {
		try {
			grnService.updateDetailOnSelfDiscardOfGRN(empId, grnId, remark, request);
		}
		catch (Exception e) {
			System.out.println("Error Occurred :" + new CodifyErrors().getErrorCode(e));// uncomment asneeded --;
		}
	}
	
	@GetMapping("/viewGrnApprovalFile")
	public Object viewFile(@RequestParam long grnId) throws Exception {
		return this.grnService.viewFile(grnId);
	}

	 
	    
}
